   <!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Mem â€” Chatroom</title>
  <style>
    :root {
      --bg: #0d1b1e; --panel: #112d32; --accent: #a8ff60; --line: #88c999;
      --text: #d0f0c0; --muted: #88c999; --danger: #ff6b6b; --info: #7bdff2; --warn: #ffd166;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:"Segoe UI",Tahoma,sans-serif; direction:rtl; }
    header { background:#1a3c40; color:var(--accent); text-align:center; padding:22px 16px; font-size:1.8rem; font-weight:800; }
    .container { max-width: 1150px; margin: 0 auto; padding: 16px; }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px; margin-top:16px; }
    .title { color:var(--accent); font-weight:700; margin-bottom:10px; }
    input,button,select { border-radius:10px; border:1px solid var(--line); background:rgba(136,201,153,0.08); color:var(--text); padding:10px 12px; font-size:1rem; }
    button { cursor:pointer; } button.primary { background:rgba(168,255,96,0.15); border-color:var(--accent); }
    .row { display:flex; gap:10px; }
    .grid { display:grid; grid-template-columns: 280px 1fr; gap:16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .profile { background:#0f2428; border:1px solid var(--line); border-radius:12px; padding:12px; }
    .avatar { width:64px; height:64px; border-radius:50%; background:rgba(136,201,153,0.15); border:1px solid var(--line); display:inline-flex; align-items:center; justify-content:center; font-size:1.4rem; margin-left:10px; }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed var(--line); border-radius:999px; color:var(--text); font-size:0.9rem; background:rgba(136,201,153,0.08); }
    .rooms { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .rooms button { padding:8px 12px; } .rooms .active { border-color:var(--accent); background:rgba(168,255,96,0.12); }
    .chat { display:grid; grid-template-rows:auto 1fr auto; gap:12px; height: 58vh; }
    .chat-log { background:#0f2428; border:1px solid var(--line); border-radius:12px; padding:12px; overflow-y:auto; }
    .msg { margin-bottom:10px; padding:8px 10px; border-radius:10px; background:rgba(168,255,96,0.06); border:1px solid rgba(168,255,96,0.2); animation: fadeIn 0.2s ease; }
    .msg .meta { font-size:0.85rem; color:var(--muted); margin-bottom:4px; display:flex; justify-content:space-between; }
    .msg .text { white-space: pre-wrap; line-height:1.5; }
    .msg.system { background:rgba(123,223,242,0.08); border-color:rgba(123,223,242,0.25); }
    .msg.warn { background:rgba(255,209,102,0.08); border-color:rgba(255,209,102,0.25); }
    .chat-input { display:flex; gap:8px; } .chat-input input { flex:1; }
    .role-owner { color:var(--warn); } .role-commander { color:var(--accent); } .role-recruit { color:var(--info); }
    .footer { text-align:center; color:var(--muted); font-size:0.9rem; padding:24px 12px 40px; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }
    .admin-tools button { margin:5px 0; width:100%; } .codes-list { margin-top:10px; color:var(--accent); font-size:0.95rem; }
    .reactions { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
    .reaction { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:rgba(168,255,96,0.08); color:var(--text); font-size:0.95rem; cursor:pointer; user-select:none; }
    .reaction:hover { background:rgba(168,255,96,0.15); } .reaction .count { color:var(--muted); font-size:0.9rem; }
    .section-title { margin-top:12px; font-weight:700; color:var(--accent); }
    .members { margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .member-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border:1px solid var(--line); border-radius:10px; background:rgba(136,201,153,0.08); }
    .dm-panel { margin-top:12px; }
    .dm-header { display:flex; align-items:center; justify-content:space-between; }
    .dm-log { background:#0f2428; border:1px solid var(--line); border-radius:12px; padding:10px; height: 220px; overflow-y:auto; margin-top:8px; }
    .dm-input { display:flex; gap:8px; margin-top:8px; }
    .broadcast-note { color:var(--muted); font-size:0.9rem; margin-bottom:8px; }
  </style>
</head>
<body>
  <header>Ø§ØªØ­Ø§Ø¯ÛŒÙ‡ Code Mem â€” Ú†Øª Ú†Ù†Ø¯Ø§ØªØ§Ù‚Ù‡ + DM + Ú©Ø§Ù†Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ</header>

  <main class="container">
    <!-- Gate -->
    <section id="gate" class="panel">
      <div class="title">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú©Ø¯ Ø§ØªØ­Ø§Ø¯ÛŒÙ‡</div>
      <p class="badge">ğŸ”° Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©ÙˆØªØ§Ù‡: Ø§Ù…Ù†ÛŒØª Ø§ÙˆÙ„ØŒ Ø·Ù†Ø² Ø¯ÙˆÙ…ØŒ Ø§Ø®Ù„Ø§Ù‚ Ù‡Ù…ÛŒØ´Ù‡</p>
      <div class="row" style="margin-top:10px;">
        <input id="codeInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: test ÛŒØ§ might" />
        <button id="enterBtn" class="primary">ÙˆØ±ÙˆØ¯</button>
      </div>
      <div id="gateError" style="color: var(--danger); margin-top: 8px;"></div>
    </section>

    <!-- App -->
    <section id="app" style="display:none;">
      <div class="grid">
        <!-- Profile + Members + Admin -->
        <aside class="profile">
          <div style="display:flex; align-items:center;">
            <div id="avatar" class="avatar">ğŸ”°</div>
            <div>
              <div id="profileName" style="font-weight:700;">Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³</div>
              <div id="profileRole" class="badge">Ù†Ù‚Ø´: recruit</div>
            </div>
          </div>

          <hr style="border-color: rgba(136,201,153,0.3); margin: 12px 0;">
          <div class="title">Ø§ØªØ§Ù‚â€ŒÙ‡Ø§</div>
          <div class="rooms" id="roomsBar"></div>
          <p class="broadcast-note">ğŸ“£ Â«Ú©Ø§Ù†Ø§Ù„ Code MemÂ» ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Owner/Commander Ù‚Ø§Ø¨Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Øª.</p>

          <div class="section-title">Ø§Ø¹Ø¶Ø§</div>
          <div id="membersList" class="members"></div>

          <!-- DM Panel -->
          <div id="dmPanel" class="panel dm-panel" style="display:none;">
            <div class="dm-header">
              <div class="title" id="dmTitle">Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ</div>
              <button id="closeDmBtn">Ø¨Ø³ØªÙ†</button>
            </div>
            <div id="dmLog" class="dm-log"></div>
            <div class="dm-input">
              <input id="dmInput" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ..." />
              <button id="dmSendBtn" class="primary">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
          </div>

          <!-- Admin Panel -->
          <div id="adminPanel" class="panel" style="display:none; margin-top:12px;">
            <div class="title">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</div>
            <div class="admin-tools">
              <button onclick="clearRoom()">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ØªØ§Ù‚ ÙØ¹Ù„ÛŒ</button>
              <button onclick="showCodes()">ğŸ”‘ Ù†Ù…Ø§ÛŒØ´ Ú©Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯</button>
              <div id="codesList" class="codes-list"></div>
            </div>
            <hr style="border-color: rgba(136,201,153,0.3); margin: 12px 0;">
            <div class="title">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ø¬Ø¯ÛŒØ¯</div>
            <input id="newCode" type="text" placeholder="Ú©Ø¯ ÙˆØ±ÙˆØ¯ Ø¬Ø¯ÛŒØ¯..." />
            <input id="newName" type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±..." />
            <select id="newRole">
              <option value="recruit">Recruit</option>
              <option value="commander">Commander</option>
              <option value="owner">Owner</option>
            </select>
            <button onclick="addCode()" class="primary">Ø«Ø¨Øª Ú©Ø¯</button>
          </div>
        </aside>

        <!-- Chat -->
        <section class="panel">
          <div class="title" id="roomTitle">Ø§ØªØ§Ù‚: Ø¹Ù…ÙˆÙ…ÛŒ</div>
          <div class="chat">
            <div id="chatLog" class="chat-log"></div>
            <div class="chat-input">
              <input id="msgInput" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³..." />
              <button id="sendBtn" class="primary">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <div class="footer">Â© Code Mem â€” Ø§ØªØ­Ø§Ø¯ Ø§Ø®Ù„Ø§Ù‚ÛŒØŒ Ø§Ù…Ù† Ùˆ ÙˆØ§ÛŒØ±Ø§Ù„</div>

  <script>
    // Access codes
    const ACCESS_CODES = {
      "ownerBaranaWelcometioaDmin": { role: "owner", name: "Hossein Barana", admin: true },
      "CM-CMD-ALPHA": { role: "commander", name: "@Germanynazy" },
      "CM-RCT-BETA": { role: "recruit", name: "@ayhangta" },
      "CM-PUBLIC-ACCESS": { role: "recruit", name: "memberpuplicac" }
    };

    // Rooms (including broadcast channel)
    const ROOMS = ["Ø¹Ù…ÙˆÙ…ÛŒ", "Ø§Ù…Ù†ÛŒØª", "Ø·Ù†Ø²", "Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§", "Ú©Ø§Ù†Ø§Ù„ Code Mem"];
    let currentRoom = "Ø¹Ù…ÙˆÙ…ÛŒ";

    // Role classes
    const ROLE_CLASS = { owner: "role-owner", commander: "role-commander", recruit: "role-recruit", system: "role-commander" };

    // DOM
    const gate = document.getElementById("gate");
    const app = document.getElementById("app");
    const codeInput = document.getElementById("codeInput");
    const enterBtn = document.getElementById("enterBtn");
    const gateError = document.getElementById("gateError");
    const avatar = document.getElementById("avatar");
    const profileName = document.getElementById("profileName");
    const profileRole = document.getElementById("profileRole");
    const adminPanel = document.getElementById("adminPanel");
    const roomsBar = document.getElementById("roomsBar");
    const roomTitle = document.getElementById("roomTitle");
    const chatLog = document.getElementById("chatLog");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const membersList = document.getElementById("membersList");
    const dmPanel = document.getElementById("dmPanel");
    const dmTitle = document.getElementById("dmTitle");
    const dmLog = document.getElementById("dmLog");
    const dmInput = document.getElementById("dmInput");
    const dmSendBtn = document.getElementById("dmSendBtn");
    const closeDmBtn = document.getElementById("closeDmBtn");

    // Storage keys
    const STORAGE_PREFIX = "codeMemRoom_";
    const REACTIONS_PREFIX = "codeMemReactions_";
    const DM_PREFIX = "codeMemDM_";
    const EMOJIS = ["ğŸ‘", "ğŸ˜‚", "ğŸ”¥", "â¤ï¸"];

    let currentUser = { name: "Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³", role: "recruit" };
    let dmTarget = null;

    function storageKey(room) { return STORAGE_PREFIX + room; }
    function reactionsKey(room) { return REACTIONS_PREFIX + room; }
    function dmKey(userA, userB) {
      const pair = [userA, userB].sort().join("__");
      return DM_PREFIX + pair;
    }

    // Messages per room
    function loadMessages(room) { const raw = localStorage.getItem(storageKey(room)); return raw ? JSON.parse(raw) : []; }
    function saveMessages(room, list) { localStorage.setItem(storageKey(room), JSON.stringify(list)); }

    // Reactions per room/message
    function loadReactions(room) { const raw = localStorage.getItem(reactionsKey(room)); return raw ? JSON.parse(raw) : {}; }
    function saveReactions(room, map) { localStorage.setItem(reactionsKey(room), JSON.stringify(map)); }

    // DM storage
    function loadDM(a, b) { const raw = localStorage.getItem(dmKey(a, b)); return raw ? JSON.parse(raw) : []; }
    function saveDM(a, b, list) { localStorage.setItem(dmKey(a, b), JSON.stringify(list)); }

    function appendMessage({ id, name, role, text, type = "normal", time }) {
      const wrap = document.createElement("div");
      wrap.className = "msg" + (type === "system" ? " system" : "") + (type === "warn" ? " warn" : "");
      wrap.dataset.id = id || "";

      const meta = document.createElement("div");
      meta.className = "meta " + (ROLE_CLASS[role] || "");
      const left = document.createElement("span");
      left.textContent = `${name} â€¢ ${time || new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })}`;
      const right = document.createElement("span");
      right.textContent = `Ø§ØªØ§Ù‚: ${currentRoom}`;
      meta.appendChild(left); meta.appendChild(right);

      const body = document.createElement("div");
      body.className = "text";
      body.textContent = text;

      wrap.appendChild(meta);
      wrap.appendChild(body);

      // Reactions (skip for system/broadcast-only note)
      if (type === "normal") {
        const reactionsDiv = document.createElement("div");
        reactionsDiv.className = "reactions";
        const reactionsMap = loadReactions(currentRoom);
        const msgReacts = reactionsMap[id] || {};
        EMOJIS.forEach(emoji => {
          const btn = document.createElement("div");
          btn.className = "reaction";
          const count = msgReacts[emoji] || 0;
          btn.innerHTML = `<span class="emoji">${emoji}</span><span class="count">${count}</span>`;
          btn.addEventListener("click", () => {
            const map = loadReactions(currentRoom);
            const current = map[id] || {};
            current[emoji] = (current[emoji] || 0) + 1;
            map[id] = current;
            saveReactions(currentRoom, map);
            renderRoom(currentRoom);
          });
          reactionsDiv.appendChild(btn);
        });
        wrap.appendChild(reactionsDiv);
      }

      chatLog.appendChild(wrap);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function renderRoom(room) {
      chatLog.innerHTML = "";
      const list = loadMessages(room);
      list.forEach(msg => appendMessage(msg));
    }

    function setRoom(room) {
      currentRoom = room;
      roomTitle.textContent = `Ø§ØªØ§Ù‚: ${room}`;
      [...roomsBar.children].forEach(btn => btn.classList.toggle("active", btn.dataset.room === room));
      renderRoom(room);
      appendMessage({
        id: "sys-" + Date.now(),
        name: "Ø³ÛŒØ³ØªÙ…",
        role: "system",
        text: `Ø¨Ù‡ Ø§ØªØ§Ù‚ Â«${room}Â» ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒ.`,
        type: "system",
        time: new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
      });
    }

    function buildRoomsBar() {
      roomsBar.innerHTML = "";
      ROOMS.forEach(room => {
        const btn = document.createElement("button");
        btn.textContent = room;
        btn.dataset.room = room;
        btn.className = "badge";
        btn.addEventListener("click", () => setRoom(room));
        roomsBar.appendChild(btn);
      });
      setRoom(currentRoom);
    }

    function setProfile(profile) {
      currentUser = { ...profile };
      profileName.textContent = profile.name;
      profileRole.textContent = `Ù†Ù‚Ø´: ${profile.role}`;
      profileRole.className = "badge " + (ROLE_CLASS[profile.role] || "");
      avatar.textContent = profile.role === "owner" ? "ğŸ”°" : profile.role === "commander" ? "ğŸš€" : "ğŸ¯";
      buildMembersList();
    }

    function buildMembersList() {
      membersList.innerHTML = "";
      const entries = Object.values(ACCESS_CODES).map(v => ({ name: v.name, role: v.role }));
      // unique by name
      const seen = new Set();
      const members = entries.filter(e => { if (seen.has(e.name)) return false; seen.add(e.name); return true; });
      members.forEach(m => {
        const item = document.createElement("div");
        item.className = "member-item";
        const info = document.createElement("div");
        info.innerHTML = `<span>${m.name}</span> <span class="badge ${ROLE_CLASS[m.role] || ""}">Ù†Ù‚Ø´: ${m.role}</span>`;
        const dmBtn = document.createElement("button");
        dmBtn.textContent = "Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ";
        dmBtn.addEventListener("click", () => openDM(m.name));
        item.appendChild(info);
        item.appendChild(dmBtn);
        membersList.appendChild(item);
      });
    }

    function openDM(targetName) {
      if (targetName === currentUser.name) { alert("Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ù‡ Ø®ÙˆØ¯Øª Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ Ø¨ÙØ±Ø³ØªÛŒ."); return; }
      dmTarget = targetName;
      dmTitle.textContent = `Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ Ø¨Ø§: ${targetName}`;
      dmPanel.style.display = "block";
      renderDM();
    }

    function closeDM() {
      dmPanel.style.display = "none";
      dmTarget = null;
      dmLog.innerHTML = "";
      dmInput.value = "";
    }

    function renderDM() {
      if (!dmTarget) return;
      dmLog.innerHTML = "";
      const list = loadDM(currentUser.name, dmTarget);
      list.forEach(m => {
        const row = document.createElement("div");
        row.className = "msg";
        const meta = document.createElement("div");
        meta.className = "meta " + (ROLE_CLASS[m.role] || "");
        meta.textContent = `${m.from} â€¢ ${m.time}`;
        const body = document.createElement("div");
        body.className = "text";
        body.textContent = m.text;
        row.appendChild(meta); row.appendChild(body);
        dmLog.appendChild(row);
      });
      dmLog.scrollTop = dmLog.scrollHeight;
    }

    function sendDM() {
      if (!dmTarget) return;
      const text = (dmInput.value || "").trim();
      if (!text) return;
      const list = loadDM(currentUser.name, dmTarget);
      list.push({
        from: currentUser.name,
        to: dmTarget,
        role: currentUser.role,
        text,
        time: new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
      });
      saveDM(currentUser.name, dmTarget, list);
      dmInput.value = "";
      renderDM();
    }

    // Broadcast permission check
    function canPostInRoom(room) {
      if (room !== "Ú©Ø§Ù†Ø§Ù„ Code Mem") return true;
      return currentUser.role === "owner" || currentUser.role === "commander";
    }

    enterBtn.addEventListener("click", () => {
      const code = (codeInput.value || "").trim();
      const profile = ACCESS_CODES[code];
      if (!profile) {
        gateError.textContent = "Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù† ÛŒØ§ Ø§Ø² Ù…Ø§Ù„Ú© Ú©Ø¯ Ø¯Ø±Ø³Øª Ø¨Ú¯ÛŒØ±.";
        return;
      }
      gateError.textContent = "";
      gate.style.display = "none";
      app.style.display = "block";
      setProfile(profile);
      if (profile.admin) adminPanel.style.display = "block";
      buildRoomsBar();
      appendMessage({
        id: "sys-" + Date.now(),
        name: "Ø³ÛŒØ³ØªÙ…",
        role: "system",
        text: `ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚: ${profile.name}`,
        type: "system",
        time: new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
      });
    });

    sendBtn.addEventListener("click", () => {
      const text = (msgInput.value || "").trim();
      if (!text) return;
      if (!canPostInRoom(currentRoom)) {
        alert("Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Â«Ú©Ø§Ù†Ø§Ù„ Code MemÂ» ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Owner/Commander Ù…Ø¬Ø§Ø² Ø§Ø³Øª.");
        return;
      }
      const id = "msg-" + Date.now();
      const msg = {
        id,
        name: currentUser.name,
        role: currentUser.role,
        text,
        type: "normal",
        time: new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
      };
      const list = loadMessages(currentRoom);
      list.push(msg);
      saveMessages(currentRoom, list);
      const reacts = loadReactions(currentRoom);
      if (!reacts[id]) { reacts[id] = {}; saveReactions(currentRoom, reacts); }
      renderRoom(currentRoom);
      msgInput.value = "";
    });

    msgInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendBtn.click(); });
    dmSendBtn.addEventListener("click", sendDM);
    dmInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendDM(); });
    closeDmBtn.addEventListener("click", closeDM);

    // Admin actions
    function clearRoom() {
      localStorage.removeItem(storageKey(currentRoom));
      localStorage.removeItem(reactionsKey(currentRoom));
      chatLog.innerHTML = "";
      appendMessage({
        id: "sys-" + Date.now(),
        name: "Ø³ÛŒØ³ØªÙ…",
        role: "system",
        text: `Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ØªØ§Ù‚ Â«${currentRoom}Â» Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.`,
        type: "warn",
        time: new Date().toLocaleTimeString("fa-IR", { hour: "2-digit", minute: "2-digit" })
      });
    }
    function showCodes() {
      const list = Object.entries(ACCESS_CODES).map(([code, v]) => {
        const 
